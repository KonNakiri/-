<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–‡åŒ–ç¥­äºˆç®—ç®¡ç†</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f4f4f4; }
    h1 { font-size: 1.5rem; }
    label { display: block; margin-top: 1rem; }
    input, button { width: 100%; padding: 0.5rem; margin-top: 0.5rem; }
    .entry { background: #fff; padding: 1rem; margin-top: 1rem; border-radius: 8px; }
    .complete { background: #d0ffd0; }
    .budget { margin-top: 2rem; font-size: 1.2rem; background: #fff; padding: 1rem; border-radius: 8px; }
    .delete-btn { background-color: #ffcccc; color: #900; margin-top: 0.5rem; padding: 0.25rem 1rem; border: none; border-radius: 4px; cursor: pointer; }
    .password-box { margin-top: 0.5rem; }
  </style>
</head>
<body>
  <h1>äºˆç®—ç”³å‘Šãƒ•ã‚©ãƒ¼ãƒ </h1>
  <form id="entry-form">
    <label>
      ä»£è¡¨è€…å:
      <input type="text" id="name" required />
    </label>
    <label>
      ä½¿ç”¨äºˆå®šé‡‘é¡ï¼ˆå††ï¼‰:
      <input type="number" id="planned" required />
    </label>
    <button type="submit">ç”³å‘Šã™ã‚‹</button>
  </form>

  <div class="budget" id="budget-summary"></div>

  <h2>ç”³å‘Šä¸€è¦§</h2>
  <div id="entries"></div>

  <p>â€»ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„äººã¯ç›´æ¥<a href="https://docs.google.com/spreadsheets/d/YOUR_SPREADSHEET_ID_HERE/edit" target="_blank">ã“ã¡ã‚‰ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ</a>ã«è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚</p>

  <script>
    const form = document.getElementById("entry-form");
    const entries = document.getElementById("entries");
    const budgetSummary = document.getElementById("budget-summary");
    const TOTAL_BUDGET = 61500;
    let requests = [];
    const actualInputPassword = "inuidondonsukininaru"; // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æŒ‡å®š

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value;
      const planned = parseInt(document.getElementById("planned").value);
      const used = calculateUsed();
      if (used + planned > TOTAL_BUDGET) {
        alert("æ®‹ã‚Šäºˆç®—ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ç”³è«‹ã§ãã¾ã›ã‚“ã€‚");
        return;
      }

      fetch("https://script.google.com/macros/s/AKfycbztHfVLyPGQmRKbJZ_YxOvNg8YUvlPdhVjZjYnUDAEq1pa8aHyrfig23t9ba5tULJFR/exec", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, planned })
      }).then(() => {
        alert("é€ä¿¡å®Œäº†ï¼");
        const id = Date.now();
        const entry = { id, name, planned, actual: null, complete: false };
        requests.push(entry);
        render();
        form.reset();
      }).catch(() => alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ"));
    });

    function calculateUsed() {
      return requests.reduce((sum, r) => {
        return sum + (r.complete ? r.actual : r.planned);
      }, 0);
    }

    function render() {
      entries.innerHTML = "";
      requests.forEach((r, index) => {
        const div = document.createElement("div");
        div.className = "entry" + (r.complete ? " complete" : "");
        div.innerHTML = `
          <strong>${r.name}</strong><br>
          äºˆå®š: ${r.planned} å††<br>
          å®Ÿç¸¾: ${r.actual != null ? r.actual + " å††" : "æœªå…¥åŠ›"}<br>
          ${!r.complete ? `<label>ä½¿ç”¨é‡‘é¡:
            <input type='number' id='actual-${r.id}' class='actual-input' /><br>
            <input type='password' id='pw-${r.id}' class='password-box' placeholder='ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰'/><br>
            <button onclick='submitActual(${r.id})'>ç¢ºå®š</button>
            <button class='delete-btn' onclick='deleteEntry(${index})'>å–æ¶ˆ</button>
          </label>` : "å®Œäº†â˜‘ï¸"}
        `;
        entries.appendChild(div);
      });
      const used = calculateUsed();
      const remaining = TOTAL_BUDGET - used;
      budgetSummary.innerHTML = `
        ğŸ’° ç·äºˆç®—: ${TOTAL_BUDGET} å††<br>
        ğŸ§¾ ä½¿ç”¨ä¸­é‡‘é¡: ${used} å††<br>
        ğŸ’¸ æ®‹ã‚Šäºˆç®—: ${remaining} å††
      `;
    }

    window.submitActual = (id) => {
      const target = requests.find(r => r.id === id);
      const input = document.getElementById(`actual-${id}`);
      const pw = document.getElementById(`pw-${id}`).value;
      const actual = parseInt(input.value);

      if (pw !== actualInputPassword) {
        alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚");
        return;
      }
      if (actual > target.planned) {
        alert("äºˆå®šé‡‘é¡ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ç™»éŒ²ã§ãã¾ã›ã‚“ã€‚");
        return;
      }
      target.actual = actual;
      target.complete = true;
      render();
    };

    window.deleteEntry = (index) => {
      if (confirm("æœ¬å½“ã«ã“ã®ç”³è«‹ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) {
        requests.splice(index, 1);
        render();
      }
    };
  </script>
</body>
</html>
